<!DOCTYPE html>
<html lang="cn">
<head>
	<meta charset="UTF-8">
	<title>Bilibili v.mini</title>
	<style>
		html, body{
			margin: 0;
			height: 100%;
		}
		webview{
			width: 100%;
			height: 100%;
		}
	</style>
</head>
<body>
	<webview id="vw" src="http://m.bilibili.com/index.html" useragent="bilimini Mobile like (iPhone or Android) whatever" preload="./inject.js"></webview>
	<script>
		const ipc = require('electron').ipcRenderer;
		const userAgent = {
			desktop: 'bilimini Desktop like Mozilla/233 (Chrome and Safari)',
			mobile: 'bilimini Mobile like (iPhone or Android) whatever'
		};
		const videoUrlPattern = /video\/av(\d+)/;

		var vw = document.getElementById('vw');
		vw.addEventListener('did-finish-load', function() {
			// vw.openDevTools();
		});
		vw.addEventListener('will-navigate', function(e) {
			let m;
			if( m = videoUrlPattern.exec(e.url) ) {
				vw.loadURL('http://bilibili.com/video/av' + m[1], {
					userAgent: userAgent.desktop
				});
				ipc.send('asynchronous-message', 'video');
			} else {
				ipc.send('asynchronous-message', 'default');
			}
		});
	</script>
</body>
</html>