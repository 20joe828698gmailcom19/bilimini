<!DOCTYPE html>
<html lang="cn">
<head>
	<meta charset="UTF-8">
	<title>Bilibili v.mini</title>
	<link rel="stylesheet" href="main.css">
</head>
<body>
	<webview id="wv" src="http://m.bilibili.com/index.html" useragent="bilimini Mobile like (iPhone or Android) whatever" preload="./inject.js"></webview>
	<div id="loading"></div>
	<div id="topbar">
		<div id="icon-bar">
			<span id="navi-back" class="top-btn icon-btn disabled" title="后退">◀</span>
			<span id="navi-forward" class="top-btn icon-btn disabled" title="前进">◀</span>
			<span id="navi-goto" class="top-btn" title="转跳到">av</span>
		</div>
		<div id="dragzone">这里可以拖拽</div>
	</div>
	<div id="input-layer">
		<input type="text" id="input" placeholder="输入要前往的av号或者视频地址"><!--
		--><span id="input-finish">确认</span>
	</div>
	<div id="mask"></div>
	<script>
		const ipc = require('electron').ipcRenderer;
		const userAgent = {
			desktop: 'bilimini Desktop like Mozilla/233 (Chrome and Safari)',
			mobile: 'bilimini Mobile like (iPhone or Android) whatever'
		};
		const videoUrlPrefix = 'http://bilibili.com/video/av';
		const videoUrlPattern = /video\/av(\d+)/;
		const wv = document.getElementById('wv');
		const naviBack = document.getElementById('navi-back'),
					naviForward = document.getElementById('navi-forward');

		wv.addEventListener('did-finish-load', function() {
			// wv.openDevTools();
			// 判断是否能前进/后退
			wv.canGoBack() ? naviBack.classList.remove('disabled') : naviBack.classList.add('disabled');
			wv.canGoForward() ? naviForward.classList.remove('disabled') : naviForward.classList.add('disabled');

			if( wv.getURL().indexOf('video/av') > -1 ) {
				ipc.send('asynchronous-message', 'video');
			} else {
				ipc.send('asynchronous-message', 'default');
			}
		});

		// 当用户点到视频播放页时跳到桌面版页面，同时缩小窗口尺寸
		wv.addEventListener('will-navigate', function(e) {
			let m = videoUrlPattern.exec(e.url);
			if( m ) {
				wv.loadURL(videoUrlPrefix + m[1], {
					userAgent: userAgent.desktop
				});
			}
		});

		// 前进 / 后退
		naviBack.addEventListener('click', () => {
			wv.goBack();
		});
		naviForward.addEventListener('click', () => {
			wv.goForward();
		});

		// av号跳转
		const inputLayer = document.getElementById('input-layer'),
					input = document.getElementById('input');
		document.getElementById('navi-goto').addEventListener('click', () => {
			input.value = '';
			inputLayer.classList.add('active');
			Mask.show();
		});
		document.getElementById('input-finish').addEventListener('click', () => {
			var target = input.value;
			if( target.startsWith('http') && target.indexOf('bilibili.com') > -1 ) {
				// is Url
				if( target.indexOf('video/av') > -1 ) {
					wv.loadURL(target, {
						userAgent: userAgent.desktop
					});
				} else {
					wv.loadURL(target);
				}
				inputLayer.classList.remove('active');
				Mask.hide();
			} else if( /^(\d+)$/.test(target) ) {
				// is avid
				wv.loadURL(videoUrlPrefix + target, {
					userAgent: userAgent.desktop
				});
				inputLayer.classList.remove('active');
				Mask.hide();
			} else {
				// not a valid input
				alert('你确定输入的是b站链接或者av号吗？');
			}
		});

		// 通用组件：阴影遮罩
		const Mask = {
			node: document.getElementById('mask'),
			show: () => {
				Mask.node.classList.add('active');
			},
			hide: () => {
				Mask.node.classList.remove('active');
			}
		};
	</script>
</body>
</html>