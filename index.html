<!DOCTYPE html>
<html lang="cn">
<head>
	<meta charset="UTF-8">
	<title>Bilibili v.mini</title>
	<style>
		html, body{
			font-size: 12px;
			font-family: 'PingFangSC-Regular', 'Microsoft Yahei';
			margin: 0;
			height: 100%;
		}
		webview{
			width: 100%;
			height: 100%;
		}
		#topbar{
			background: #f25d8e;
			box-sizing: border-box;
			line-height: 36px;
			padding: 0 1em;
			position: fixed;
			top: -36px;
			left: 0;
			width: 100%;
			transition: top .1s ease;
		}
		body:hover #topbar{
			top: 0;
			opacity: 1;
		}
		#icon-bar{
			position: absolute;
			top: 0;
			left: 10px;
		}
		.top-btn{
			background: #fb93ab;
			color: #f25d8e;
			cursor: pointer;
			display: inline-block;
			vertical-align: middle;
			margin-right: 2px;
			transition: all .2s ease;
		}
		.top-btn:hover{
			background: #fff;
		}
		.top-btn.disabled{
			opacity: .5;
		}
		.top-btn.disabled:hover{
			background: #fb93ab;
		}
		.icon-btn{
			border-radius: 14px;
			font-size: 7px;
			width: 14px;
			height: 14px;
			text-align: center;
		}
		#navi-back{
			line-height: 15px;
			text-indent: -1px;
		}
		#navi-forward{
			line-height: 15px;
			text-indent: -1px;
			transform: rotate(180deg);
		}
		#navi-goto{
			border-radius: 3px;
			font-size: 14px;
			line-height: 15px;
			padding: 0 5px;
		}
		#dragzone{
			-webkit-app-region: drag;
			color: #ffacbf;
			cursor: move;
			text-align: center;
			width: 50%;
			margin: 0 auto;
		}
		#dragzone:hover{
			color: #fff;
		}
	</style>
</head>
<body>
	<webview id="wv" src="http://m.bilibili.com/index.html" useragent="bilimini Mobile like (iPhone or Android) whatever" preload="./inject.js"></webview>
	<div id="loading"></div>
	<div id="topbar">
		<div id="icon-bar">
			<span id="navi-back" class="top-btn icon-btn disabled" title="后退">◀</span>
			<span id="navi-forward" class="top-btn icon-btn disabled" title="前进">◀</span>
			<span id="navi-goto" class="top-btn" title="转跳到">av</span>
		</div>
		<div id="dragzone">这里可以拖拽</div>
	</div>
	<script>
		const ipc = require('electron').ipcRenderer;
		const userAgent = {
			desktop: 'bilimini Desktop like Mozilla/233 (Chrome and Safari)',
			mobile: 'bilimini Mobile like (iPhone or Android) whatever'
		};
		const videoUrlPattern = /video\/av(\d+)/;
		const wv = document.getElementById('wv');
		const naviBack = document.getElementById('navi-back'),
					naviForward = document.getElementById('navi-forward');
					
		wv.addEventListener('did-finish-load', function() {
			// wv.openDevTools();
			// 判断是否能前进/后退
			wv.canGoBack() ? naviBack.classList.remove('disabled') : naviBack.classList.add('disabled');
			wv.canGoForward() ? naviForward.classList.remove('disabled') : naviForward.classList.add('disabled');

			if( wv.getURL().indexOf('video/av') > -1 ) {
				ipc.send('asynchronous-message', 'video');
			} else {
				ipc.send('asynchronous-message', 'default');
			}
		});

		// 当用户点到视频播放页时跳到桌面版页面，同时缩小窗口尺寸
		wv.addEventListener('will-navigate', function(e) {
			let m = videoUrlPattern.exec(e.url);
			if( m ) {
				wv.loadURL('http://bilibili.com/video/av' + m[1], {
					userAgent: userAgent.desktop
				});
			}
		});

		// 前进 / 后退
		naviBack.addEventListener('click', () => {
			wv.goBack();
		});
		naviForward.addEventListener('click', () => {
			wv.goForward();
		});
	</script>
</body>
</html>