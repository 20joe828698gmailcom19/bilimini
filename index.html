<!DOCTYPE html>
<html lang="cn">
<head>
	<meta charset="UTF-8">
	<title>Bilibili v.mini</title>
	<link rel="stylesheet" href="main.css">
</head>
<body>
	<webview id="wv" src="http://m.bilibili.com/index.html" useragent="bilimini Mobile like (iPhone or Android) whatever" preload="./inject.js"></webview>
	<div id="wrapper">
		<div id="loading"></div>
		<div id="topbar" :class="{active: showTopBar}">
			<div id="icon-bar-left">
				<span id="navi-back" class="top-btn icon-btn" :disabled="!naviCanGoBack" @click="naviBack">◀</span>
				<span id="navi-forward" class="top-btn icon-btn" :disabled="!naviCanGoForward" @click="naviForward">◀</span>
				<span id="navi-goto" class="top-btn" title="转跳到" @click="naviGotoShow">av</span>
			</div>
			<div id="dragzone">这里可以拖拽</div>
			<div id="icon-bar-right">
				<span id="app-close" class="top-btn icon-btn" @click="turnOff">x</span>
			</div>
		</div>
		<div :class="{globalOverlay: 1, active: showGlobalOverlay}" @click="naviGotoHide">
			<div id="input-layer" :class="{active: naviGotoInputShow}" @click.stop>
				<input type="text" id="input" placeholder="输入要前往的av号或者视频地址" v-model="naviGotoTarget" @keyup.enter="naviGoto"><!--
				--><span id="input-finish" @click="naviGoto">确认</span>
			</div>
		</div>
	</div>
	<script src="js/vue.min.js"></script>
	<script>
		const ipc = require('electron').ipcRenderer;
		const remote = require('electron').remote;
		const userAgent = {
			desktop: 'bilimini Desktop like Mozilla/233 (Chrome and Safari)',
			mobile: 'bilimini Mobile like (iPhone or Android) whatever'
		};
		const videoUrlPrefix = 'http://bilibili.com/video/av';
		const videoUrlPattern = /video\/av(\d+)/;
		const wv = document.getElementById('wv');

		const v = new Vue({
			el: '#wrapper',
			data: {
				showTopBar: false,
				naviGotoTarget: '',
				naviGotoInputShow: false,
				naviCanGoBack: false,
				naviCanGoForward: false,
				showGlobalOverlay: false
			},
			methods: {
				// 后退
				naviBack: function() {
					wv.goBack();
				},
				// 前进
				naviForward: function() {
					wv.goForward();
				},
				// 通过url或av号跳转
				naviGotoShow: function() {
					this.naviGotoTarget = '';
					this.naviGotoInputShow = true;
					this.showGlobalOverlay = true;
				},
				naviGotoHide: function() {
					this.naviGotoInputShow = this.showGlobalOverlay = false;
				},
				naviGoto: function() {
					var target = this.naviGotoTarget;
					if( target.startsWith('http') && target.indexOf('bilibili.com') > -1 ) {
						// is Url
						if( target.indexOf('video/av') > -1 ) {
							wv.loadURL(target, {
								userAgent: userAgent.desktop
							});
						} else {
							wv.loadURL(target);
						}
						this.naviGotoHide();
					} else if( /^(\d+)$/.test(target) ) {
						// is avid
						wv.loadURL(videoUrlPrefix + target, {
							userAgent: userAgent.desktop
						});
						this.naviGotoHide();
					} else {
						// not a valid input
						alert('你确定输入的是b站链接或者av号吗？');
					}
				},
				// 关鸡
				turnOff: function() {
					remote.getCurrentWindow().close();
				}
			}
		});

		wv.addEventListener('did-finish-load', function() {
			// wv.openDevTools();
			// 判断是否能前进/后退
			v.naviCanGoBack = wv.canGoBack();
			v.naviCanGoForward = wv.canGoForward();

			if( wv.getURL().indexOf('video/av') > -1 ) {
				ipc.send('asynchronous-message', 'video');
			} else {
				ipc.send('asynchronous-message', 'default');
			}
		});

		// 当用户点到视频播放页时跳到桌面版页面，同时缩小窗口尺寸
		wv.addEventListener('will-navigate', function(e) {
			let m = videoUrlPattern.exec(e.url);
			if( m ) {
				wv.loadURL(videoUrlPrefix + m[1], {
					userAgent: userAgent.desktop
				});
			}
		});

		if( process.platform.startsWith('win') ) {
			document.body.classList.add('windows');
			// windows下frameless window没法正确检测到mouseout事件，所以只能用focus/blur来代替了
			ipc.on('mousein', () => v.showTopBar = true);
			ipc.on('mouseout', () => v.showTopBar = false)
		} else if( process.platform == 'darwin' ) {
			document.body.classList.add('macos');
		}
	</script>
</body>
</html>